#! /bin/sh
#
# Generate output from dbdSensors and compare to expected output
#
# Mar-2012, Pat Welch, pat@mousebrains.com
#

CMD=../bin/dbd2netCDF
TMP=../tmp

if [ ! -x "$CMD" ] ; then
  echo "$CMD is not executable"
  exit 1
fi

if ! mkdir -p "$TMP" ; then
  echo "Unable to create $TMP"
  exit 1
fi

chkCMD() {
  if ! "$@" </dev/null >/dev/null 2>&1; then
    echo "No $1 command found"
    exit 1
  fi
}

doCompare() {
  tmpfn=$TMP/dbd.out.$$
  tmp1fn=$TMP/dbd.out.1.$$
  tmp2fn=$TMP/dbd.out.2.$$

  ref=$1
  shift

  if [ ! -e "$ref" ] ; then
    echo "Reference file $ref does not exist"
    exit 1
  fi

  for file in "$@" ; do
    if [ ! -e "$file" ] ; then
      echo "Dinkum Binary Data file $file does not exist"
      exit 1
    fi
  done

  if ! "$CMD" -o "$tmpfn" "$@" ; then
    echo "Failed to execute $CMD on $*"
    rm -f "$tmpfn"
    exit 1
  fi

  if ! ncdump "$tmpfn" >"$tmp1fn" ; then
    echo "Failed to execute ncdump on $tmpfn"
    rm -f "$tmpfn" "$tmp1fn" "$tmp2fn"
    exit 1
  fi

  if ! tail -n +2 "$tmp1fn" >"$tmp2fn" ; then # Get rid of first line which contains filename
    echo "Failed to execute tail on $tmp1fn"
    rm -f "$tmpfn" "$tmp1fn" "$tmp2fn"
    exit 1
  fi

  if ! tail -n +2 "$ref" >"$tmp1fn" ; then # Get rid of first line which contains filename
    echo "Failed to execute tail on $ref"
    rm -f "$tmpfn" "$tmp1fn" "$tmp2fn"
    exit 1
  fi

  if ! diff -q --strip-trailing-cr "$tmp2fn" "$tmp1fn" ; then
    echo "Failed on comparison of $* sensors"
    diff --strip-trailing-cr "$tmp2fn" "$tmp1fn"
    rm -f "$tmpfn" "$tmp1fn" "$tmp2fn"
    exit 1
  fi

  rm -f "$tmpfn" "$tmp1fn" "$tmp2fn"
}

chkCMD diff --version
chkCMD grep --version
chkCMD tail

doCompare test.sbd.netCDF test.sbd
doCompare test.tbd.netCDF test.tbd
doCompare test.both.netCDF test.sbd test.tbd

# Test with real DCD data (single file and combined)
doCompare data/00300000.dcd.ncdump data/00300000.dcd
doCompare data/00300000.combined.ncdump data/00300000.dcd data/00300000.scd data/00300000.tcd data/00300000.ecd

# Test command-line options
echo "Testing version flag..."
if ! "$CMD" --version >/dev/null 2>&1; then
  echo "Version flag failed"
  exit 1
fi

echo "Testing help flag..."
if ! "$CMD" --help >/dev/null 2>&1; then
  echo "Help flag failed"
  exit 1
fi

# Test error handling - should fail gracefully for non-existent file
echo "Testing non-existent file error handling..."
if "$CMD" -o /dev/null nonexistent.dbd 2>/dev/null; then
  echo "Should have failed for non-existent file"
  exit 1
fi

# Test log level option
echo "Testing log level option..."
if ! "$CMD" -l debug -o "$TMP/debug.nc" data/00300000.dcd 2>/dev/null; then
  echo "Debug log level failed"
  rm -f "$TMP/debug.nc"
  exit 1
fi
rm -f "$TMP/debug.nc"

# Test strict mode with valid file (should succeed)
echo "Testing strict mode with valid file..."
if ! "$CMD" -S -o "$TMP/strict.nc" data/00300000.dcd 2>/dev/null; then
  echo "Strict mode with valid file failed"
  rm -f "$TMP/strict.nc"
  exit 1
fi
rm -f "$TMP/strict.nc"

exit 0
