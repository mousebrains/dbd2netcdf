#! /bin/sh
#
# Generate output from dbd2csv and compare to expected output
#
# Mar-2012, Pat Welch, pat@mousebrains.com
#

CMD=../bin/dbd2csv
TMP=../tmp

if [ ! -x "$CMD" ] ; then
  echo "$CMD is not executable"
  exit 1
fi

if ! diff --version >/dev/null ; then
  echo No diff command found
  exit 1
fi

if ! mkdir -p "$TMP" ; then
  echo "Unable to create $TMP"
  exit 1
fi

doCompare() {
  tmpfn=$TMP/dbdcsv.out.$$
  ref=$1
  shift

  if [ ! -e "$ref" ] ; then
    echo "Reference file $ref does not exist"
    exit 1
  fi

  for file in "$@" ; do
    if [ ! -e "$file" ] ; then
      echo "Dinkum Binary Data file $file does not exist"
      exit 1
    fi
  done

  if ! "$CMD" -o "$tmpfn" "$@" ; then
    echo "Failed to execute $CMD on $*"
    rm -f "$tmpfn"
    exit 1
  fi

  if ! diff -q --strip-trailing-cr "$tmpfn" "$ref" ; then
    echo "Failed on comparison of $* sensors"
    diff --strip-trailing-cr "$tmpfn" "$ref"
    rm -f "$tmpfn"
    exit 1
  fi

  rm -f "$tmpfn"
}

doCompare test.sbd.csv test.sbd
doCompare test.tbd.csv test.tbd
doCompare test.both.csv test.sbd test.tbd

# Test with real DCD data
doCompare data/00300000.dcd.csv data/00300000.dcd

# Test command-line options
echo "Testing version flag..."
if ! "$CMD" --version >/dev/null 2>&1; then
  echo "Version flag failed"
  exit 1
fi

echo "Testing help flag..."
if ! "$CMD" --help >/dev/null 2>&1; then
  echo "Help flag failed"
  exit 1
fi

# Test error handling - should fail gracefully for non-existent file
echo "Testing non-existent file error handling..."
if "$CMD" -o /dev/null nonexistent.dbd 2>/dev/null; then
  echo "Should have failed for non-existent file"
  exit 1
fi

# Test log level option
echo "Testing log level option..."
if ! "$CMD" -l debug -o "$TMP/debug.csv" data/00300000.dcd 2>/dev/null; then
  echo "Debug log level failed"
  rm -f "$TMP/debug.csv"
  exit 1
fi
rm -f "$TMP/debug.csv"

exit 0
