name: Build and Test

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      job:
        description: 'Job to run (leave empty for all)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - cygwin-only

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-linux:
    if: github.event_name != 'workflow_dispatch' || inputs.job == ''
    name: ${{ matrix.os }} - ${{ matrix.compiler }} ${{ matrix.version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # GCC versions on Ubuntu
          - os: ubuntu-22.04
            compiler: gcc
            version: 10
            install: gcc-10 g++-10
          - os: ubuntu-22.04
            compiler: gcc
            version: 11
            install: gcc-11 g++-11
          - os: ubuntu-22.04
            compiler: gcc
            version: 12
            install: gcc-12 g++-12
          - os: ubuntu-24.04
            compiler: gcc
            version: 13
            install: gcc-13 g++-13
          - os: ubuntu-24.04
            compiler: gcc
            version: 14
            install: gcc-14 g++-14

          # Clang versions
          - os: ubuntu-22.04
            compiler: clang
            version: 12
            install: clang-12
          - os: ubuntu-22.04
            compiler: clang
            version: 14
            install: clang-14
          - os: ubuntu-24.04
            compiler: clang
            version: 15
            install: clang-15
          - os: ubuntu-24.04
            compiler: clang
            version: 18
            install: clang-18

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake libnetcdf-dev libhdf5-dev ${{ matrix.install }}

    - name: Set up compiler
      run: |
        if [ "${{ matrix.compiler }}" = "gcc" ]; then
          echo "CC=gcc-${{ matrix.version }}" >> $GITHUB_ENV
          echo "CXX=g++-${{ matrix.version }}" >> $GITHUB_ENV
        else
          echo "CC=clang-${{ matrix.version }}" >> $GITHUB_ENV
          echo "CXX=clang++-${{ matrix.version }}" >> $GITHUB_ENV
        fi

    - name: Display compiler version
      run: |
        $CC --version
        $CXX --version
        cmake --version

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_C_COMPILER=$CC \
              -DCMAKE_CXX_COMPILER=$CXX

    - name: Build
      run: cmake --build build --config Release

    - name: List built executables
      run: |
        ls -lh bin/
        file bin/*

    - name: Run basic tests
      run: |
        cd build
        ctest --output-on-failure || echo "No tests configured"

  lint-shell:
    if: github.event_name != 'workflow_dispatch' || inputs.job == ''
    name: Shellcheck
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install shellcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck

    - name: Shellcheck test scripts
      run: |
        shellcheck -s sh test/dbd2netCDF test/dbd2csv test/dbdSensors test/pd02netCDF

  lint-cpp:
    if: github.event_name != 'workflow_dispatch' || inputs.job == ''
    name: C++ Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck

    - name: Run cppcheck
      run: |
        cppcheck --enable=warning \
          --error-exitcode=1 \
          --suppress=missingIncludeSystem \
          --suppress=uninitvar:src/lz4.c \
          --suppress=unusedStructMember:src/lz4.c \
          --suppress=constVariablePointer:src/lz4.c \
          --suppress=duplInheritedMember \
          --suppress=uninitMemberVar \
          --inline-suppr \
          src/
        # Run performance/portability checks as informational (non-blocking)
        echo "=== Performance and portability suggestions (non-blocking) ==="
        cppcheck --enable=performance,portability \
          --suppress=missingIncludeSystem \
          src/ || true

  build-asan:
    if: github.event_name != 'workflow_dispatch' || inputs.job == ''
    name: AddressSanitizer
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake libnetcdf-dev libhdf5-dev

    - name: Configure CMake with sanitizers
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -g" \
          -DCMAKE_C_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -g" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined"

    - name: Build
      run: cmake --build build

    - name: Run tests with sanitizers
      env:
        ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
        UBSAN_OPTIONS: print_stacktrace=1:abort_on_error=1
      run: |
        cd build
        ctest --output-on-failure

  codeql:
    if: github.event_name != 'workflow_dispatch' || inputs.job == ''
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: cpp

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake libnetcdf-dev libhdf5-dev

    - name: Build for CodeQL
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  build-macos:
    if: github.event_name != 'workflow_dispatch' || inputs.job == ''
    name: macOS - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, macos-15]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        for pkg in cmake netcdf hdf5; do
          brew list $pkg &>/dev/null || brew install $pkg
        done

    - name: Display compiler version
      run: |
        clang --version
        cmake --version

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: List built executables
      run: |
        ls -lh bin/
        file bin/*

    - name: Run basic tests
      run: |
        cd build
        ctest --output-on-failure || echo "No tests configured"

  build-cygwin:
    name: Cygwin - windows-latest
    runs-on: windows-latest
    env:
      CYGWIN: winsymlinks:native
    defaults:
      run:
        shell: D:\cygwin\bin\bash.exe --login -o igncr -eo pipefail '{0}'

    steps:
    - name: Configure git line endings
      run: git config --global core.autocrlf input
      shell: cmd

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Cache Cygwin
      uses: actions/cache@v4
      with:
        path: D:\cygwin
        key: cygwin-v6-${{ hashFiles('.github/workflows/build-test.yml') }}
        restore-keys: cygwin-v6-

    - name: Set up Cygwin
      uses: cygwin/cygwin-install-action@v6
      id: cygwin-setup
      continue-on-error: true
      with:
        packages: |
          cmake
          gcc-core
          gcc-g++
          make
          netcdf
          libnetcdf-devel
          hdf5
          libhdf5-devel
          diffutils
          coreutils
          grep
          file
          tar

    - name: Retry Cygwin setup on failure
      if: steps.cygwin-setup.outcome == 'failure'
      uses: cygwin/cygwin-install-action@v6
      with:
        packages: |
          cmake
          gcc-core
          gcc-g++
          make
          netcdf
          libnetcdf-devel
          hdf5
          libhdf5-devel
          diffutils
          coreutils
          grep
          file
          tar

    - name: Prepare Cygwin workspace
      shell: D:\cygwin\bin\bash.exe --login -o igncr -eo pipefail '{0}'
      run: |
        echo "=== Environment diagnostics ==="
        echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
        src="$(cygpath -u "$GITHUB_WORKSPACE")"
        echo "Source path (Unix): $src"
        echo "=== Source directory contents ==="
        ls -la "$src" || { echo "Cannot list source directory"; exit 1; }
        echo "=== Source src/ directory ==="
        ls -la "$src/src/" || { echo "Cannot list src directory"; exit 1; }

        work="/tmp/dbd2netcdf-work"
        echo "Work path: $work"
        rm -rf "$work"
        mkdir -p "$work"

        # Use tar to copy files - avoids permission preservation issues on Cygwin
        echo "=== Copying files with tar ==="
        (cd "$src" && tar cf - --exclude='.git' .) | (cd "$work" && tar xf -)

        echo "CYGWIN_WORKSPACE=$work" >> $GITHUB_ENV

        # Verify copy succeeded
        echo "=== Workspace contents ==="
        ls -la "$work"
        echo "=== Workspace src/ directory ==="
        ls -la "$work/src/"
        test -f "$work/CMakeLists.txt" || { echo "ERROR: CMakeLists.txt not found"; exit 1; }
        test -f "$work/src/sgMergeNetCDF.C" || { echo "ERROR: src/sgMergeNetCDF.C not found"; exit 1; }
        echo "=== File count comparison ==="
        echo "Source files: $(find "$src" -type f | wc -l)"
        echo "Workspace files: $(find "$work" -type f | wc -l)"
        echo "Workspace preparation successful"

    - name: Display compiler version
      run: |
        gcc --version
        g++ --version
        cmake --version

    - name: Verify NetCDF tools
      run: |
        cd "$CYGWIN_WORKSPACE"
        nc-config --version
        if ncdump --version >/dev/null 2>&1; then
          ncdump --version
        else
          if command -v ncdump >/dev/null 2>&1; then
            echo "ncdump found: $(command -v ncdump)"
          else
            echo "ncdump not found"
            exit 1
          fi
        fi

    - name: Configure CMake
      run: |
        cd "$CYGWIN_WORKSPACE"
        # Clean any existing build directory
        rm -rf build
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

    - name: Verify source files before build
      run: |
        cd "$CYGWIN_WORKSPACE"
        echo "=== Checking critical source files ==="
        for f in src/sgMergeNetCDF.C src/dbd2netCDF.C src/CMakeLists.txt; do
          if [ -f "$f" ]; then
            echo "OK: $f exists ($(wc -c < "$f") bytes)"
          else
            echo "MISSING: $f"
            exit 1
          fi
        done
        echo "=== All source files verified ==="

    - name: Build
      run: |
        cd "$CYGWIN_WORKSPACE"
        echo "=== Source directory contents ==="
        ls -la src/
        echo "=== Check sgMergeNetCDF.C ==="
        ls -la src/sgMergeNetCDF.C || echo "FILE NOT FOUND!"
        cat src/sgMergeNetCDF.C | head -5 || echo "CANNOT READ FILE!"
        echo "=== CMakeCache paths ==="
        grep -i "source_dir\|sgmerge" build/CMakeCache.txt || true
        echo "=== Build directory contents ==="
        ls -la build/
        echo "=== Starting build ==="
        cmake --build build --config Release -- VERBOSE=1

    - name: List built executables
      run: |
        ls -lh "$CYGWIN_WORKSPACE/bin/"
        file "$CYGWIN_WORKSPACE/bin/"*

    - name: Run tests
      timeout-minutes: 15
      run: |
        cd "$CYGWIN_WORKSPACE/build"
        ctest --output-on-failure --timeout 120 || {
          echo "=== Test failure diagnostics ==="
          cat Testing/Temporary/LastTest.log 2>/dev/null || true
          ls -la "$CYGWIN_WORKSPACE/test/"
          exit 1
        }

  build-alma:
    if: github.event_name != 'workflow_dispatch' || inputs.job == ''
    name: Alma Linux 8 (GCC 8.5)
    runs-on: ubuntu-latest
    container:
      image: almalinux:8

    steps:
    - name: Install git (required for checkout)
      run: |
        dnf install -y git

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        dnf install -y epel-release
        dnf config-manager --set-enabled powertools || \
          dnf config-manager --set-enabled crb
        dnf install -y cmake gcc-c++ make netcdf-devel hdf5-devel file

    - name: Display compiler version
      run: |
        gcc --version
        g++ --version
        cmake --version

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: List built executables
      run: |
        ls -lh bin/
        file bin/*

    - name: Verify GCC 8.5 stdc++fs linking
      run: |
        # Verify that stdc++fs is being linked for GCC 8.x
        ldd bin/dbd2netCDF | grep stdc++ || echo "stdc++ found in dependencies"
