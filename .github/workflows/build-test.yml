name: Build and Test

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  build-linux:
    name: ${{ matrix.os }} - ${{ matrix.compiler }} ${{ matrix.version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # GCC versions on Ubuntu
          - os: ubuntu-22.04
            compiler: gcc
            version: 10
            install: gcc-10 g++-10
          - os: ubuntu-22.04
            compiler: gcc
            version: 11
            install: gcc-11 g++-11
          - os: ubuntu-22.04
            compiler: gcc
            version: 12
            install: gcc-12 g++-12
          - os: ubuntu-24.04
            compiler: gcc
            version: 13
            install: gcc-13 g++-13
          - os: ubuntu-24.04
            compiler: gcc
            version: 14
            install: gcc-14 g++-14

          # Clang versions
          - os: ubuntu-22.04
            compiler: clang
            version: 12
            install: clang-12
          - os: ubuntu-22.04
            compiler: clang
            version: 14
            install: clang-14
          - os: ubuntu-24.04
            compiler: clang
            version: 15
            install: clang-15
          - os: ubuntu-24.04
            compiler: clang
            version: 18
            install: clang-18

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake libnetcdf-dev libhdf5-dev ${{ matrix.install }}

    - name: Set up compiler
      run: |
        if [ "${{ matrix.compiler }}" = "gcc" ]; then
          echo "CC=gcc-${{ matrix.version }}" >> $GITHUB_ENV
          echo "CXX=g++-${{ matrix.version }}" >> $GITHUB_ENV
        else
          echo "CC=clang-${{ matrix.version }}" >> $GITHUB_ENV
          echo "CXX=clang++-${{ matrix.version }}" >> $GITHUB_ENV
        fi

    - name: Display compiler version
      run: |
        $CC --version
        $CXX --version
        cmake --version

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_C_COMPILER=$CC \
              -DCMAKE_CXX_COMPILER=$CXX

    - name: Build
      run: cmake --build build --config Release

    - name: List built executables
      run: |
        ls -lh bin/
        file bin/*

    - name: Run basic tests
      run: |
        cd build
        ctest --output-on-failure || echo "No tests configured"

  lint-shell:
    name: Shellcheck
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install shellcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck

    - name: Shellcheck test scripts
      run: |
        shellcheck -s sh test/dbd2netCDF test/dbd2csv test/dbdSensors test/pd02netCDF

  build-macos:
    name: macOS - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, macos-15]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        for pkg in cmake netcdf hdf5; do
          brew list $pkg &>/dev/null || brew install $pkg
        done

    - name: Display compiler version
      run: |
        clang --version
        cmake --version

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: List built executables
      run: |
        ls -lh bin/
        file bin/*

    - name: Run basic tests
      run: |
        cd build
        ctest --output-on-failure || echo "No tests configured"

  build-cygwin:
    name: Cygwin - windows-latest
    runs-on: windows-latest
    defaults:
      run:
        shell: C:\tools\cygwin\bin\bash.exe --login -o igncr -eo pipefail '{0}'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Cygwin
      uses: egor-tensin/setup-cygwin@v4
      with:
        packages: >-
          cmake
          gcc-core
          gcc-g++
          make
          netcdf
          libnetcdf-devel
          hdf5
          libhdf5-devel
          diffutils
          coreutils
          grep

    - name: Display compiler version
      run: |
        gcc --version
        g++ --version
        cmake --version

    - name: Verify NetCDF tools
      run: |
        nc-config --version
        if ncdump --version >/dev/null 2>&1; then
          ncdump --version
        else
          ncdump -k test/test.sbd.netCDF
        fi

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure

  build-alma:
    name: Alma Linux 8 (GCC 8.5)
    runs-on: ubuntu-latest
    container:
      image: almalinux:8

    steps:
    - name: Install git (required for checkout)
      run: |
        dnf install -y git

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        dnf install -y epel-release
        dnf config-manager --set-enabled powertools || \
          dnf config-manager --set-enabled crb
        dnf install -y cmake gcc-c++ make netcdf-devel hdf5-devel file

    - name: Display compiler version
      run: |
        gcc --version
        g++ --version
        cmake --version

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: List built executables
      run: |
        ls -lh bin/
        file bin/*

    - name: Verify GCC 8.5 stdc++fs linking
      run: |
        # Verify that stdc++fs is being linked for GCC 8.x
        ldd bin/dbd2netCDF | grep stdc++ || echo "stdc++ found in dependencies"
