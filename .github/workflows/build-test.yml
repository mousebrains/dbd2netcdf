name: Build and Test

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-linux:
    name: ${{ matrix.os }} - ${{ matrix.compiler }} ${{ matrix.version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # GCC versions on Ubuntu
          # Note: GCC 8.5 tested on AlmaLinux for legacy C++17 support
          - os: ubuntu-latest
            compiler: gcc
            version: 9
            install: gcc-9 g++-9
          - os: ubuntu-latest
            compiler: gcc
            version: 10
            install: gcc-10 g++-10
          - os: ubuntu-latest
            compiler: gcc
            version: 11
            install: gcc-11 g++-11
          - os: ubuntu-latest
            compiler: gcc
            version: 12
            install: gcc-12 g++-12
          - os: ubuntu-latest
            compiler: gcc
            version: 13
            install: gcc-13 g++-13
          - os: ubuntu-latest
            compiler: gcc
            version: 14
            install: gcc-14 g++-14

          # Clang versions
          - os: ubuntu-latest
            compiler: clang
            version: 16
            install: clang-16
          - os: ubuntu-latest
            compiler: clang
            version: 17
            install: clang-17
          - os: ubuntu-latest
            compiler: clang
            version: 18
            install: clang-18
          - os: ubuntu-latest
            compiler: clang
            version: 19
            install: clang-19

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake libnetcdf-dev libhdf5-dev netcdf-bin ${{ matrix.install }}

    - name: Set up compiler
      run: |
        if [ "${{ matrix.compiler }}" = "gcc" ]; then
          echo "CC=gcc-${{ matrix.version }}" >> $GITHUB_ENV
          echo "CXX=g++-${{ matrix.version }}" >> $GITHUB_ENV
        else
          echo "CC=clang-${{ matrix.version }}" >> $GITHUB_ENV
          echo "CXX=clang++-${{ matrix.version }}" >> $GITHUB_ENV
        fi

    - name: Display compiler version
      run: |
        $CC --version
        $CXX --version
        cmake --version

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_C_COMPILER=$CC \
              -DCMAKE_CXX_COMPILER=$CXX

    - name: Build
      run: cmake --build build --config Release

    - name: List built executables
      run: |
        ls -lh bin/
        file bin/*

    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure

  lint-shell:
    name: Shellcheck
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install shellcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck

    - name: Shellcheck test scripts
      run: |
        shellcheck -s sh test/dbd2netCDF test/dbd2csv test/dbdSensors test/pd02netCDF

  lint-cpp:
    name: C++ Static Analysis
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install cppcheck
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck

    - name: Run cppcheck
      run: |
        cppcheck --enable=warning \
          --error-exitcode=1 \
          --suppress=missingIncludeSystem \
          --suppress=uninitvar:src/lz4.c \
          --suppress=unusedStructMember:src/lz4.c \
          --suppress=constVariablePointer:src/lz4.c \
          --suppress=duplInheritedMember \
          --suppress=uninitMemberVar \
          --inline-suppr \
          src/
        # Run performance/portability checks as informational (non-blocking)
        echo "=== Performance and portability suggestions (non-blocking) ==="
        cppcheck --enable=performance,portability \
          --suppress=missingIncludeSystem \
          src/ || true

  lint-clang-tidy:
    name: clang-tidy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-tidy cmake libnetcdf-dev libhdf5-dev

    - name: Configure CMake (generate compile_commands.json)
      run: |
        cmake -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

    - name: Run clang-tidy
      run: |
        clang-tidy -p build \
          --checks='-*,bugprone-*,-bugprone-narrowing-conversions,-bugprone-exception-escape,-bugprone-easily-swappable-parameters,-bugprone-assignment-in-if-condition,-bugprone-branch-clone,-bugprone-suspicious-string-compare,-bugprone-switch-missing-default-case,-bugprone-implicit-widening-of-multiplication-result,-bugprone-reserved-identifier,-bugprone-signed-char-misuse,-bugprone-macro-parentheses' \
          --warnings-as-errors='bugprone-*' \
          --header-filter='src/.*' \
          src/*.C

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake libnetcdf-dev libhdf5-dev netcdf-bin lcov

    - name: Configure CMake with coverage
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
          -DCMAKE_C_FLAGS="--coverage -fprofile-arcs -ftest-coverage"

    - name: Build
      run: cmake --build build

    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure

    - name: Generate coverage report
      run: |
        lcov --capture --directory build --output-file coverage.info \
          --ignore-errors gcov
        lcov --remove coverage.info '/usr/*' '*/test/*' '*/_deps/*' \
          --output-file coverage.info --ignore-errors unused
        lcov --list coverage.info

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: coverage.info
        fail_ci_if_error: false
        verbose: true

  build-asan:
    name: AddressSanitizer
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake libnetcdf-dev libhdf5-dev netcdf-bin

    - name: Configure CMake with sanitizers
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -g" \
          -DCMAKE_C_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -g" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined"

    - name: Build
      run: cmake --build build

    - name: Run tests with sanitizers
      env:
        ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
        UBSAN_OPTIONS: print_stacktrace=1:abort_on_error=1
      run: |
        cd build
        ctest --output-on-failure

  codeql:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: cpp

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake libnetcdf-dev libhdf5-dev netcdf-bin

    - name: Build for CodeQL
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4

  build-macos:
    name: macOS - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, macos-15, macos-26]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        for pkg in cmake netcdf hdf5; do
          brew list $pkg &>/dev/null || brew install $pkg
        done

    - name: Display compiler version
      run: |
        clang --version
        cmake --version

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: List built executables
      run: |
        ls -lh bin/
        file bin/*

    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure

  build-cygwin:
    name: Cygwin - windows-latest
    runs-on: windows-latest
    env:
      CYGWIN: winsymlinks:native
    defaults:
      run:
        shell: D:\cygwin\bin\bash.exe --login -o igncr -eo pipefail '{0}'

    steps:
    - name: Configure git line endings
      run: git config --global core.autocrlf input
      shell: cmd

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Cache Cygwin
      uses: actions/cache@v4
      with:
        path: D:\cygwin
        key: cygwin-v6-${{ hashFiles('.github/workflows/build-test.yml') }}
        restore-keys: cygwin-v6-

    - name: Set up Cygwin
      uses: cygwin/cygwin-install-action@v6
      id: cygwin-setup
      continue-on-error: true
      with:
        packages: |
          cmake
          gcc-core
          gcc-g++
          make
          netcdf
          libnetcdf-devel
          hdf5
          libhdf5-devel
          diffutils
          coreutils
          grep
          file
          tar

    - name: Retry Cygwin setup on failure
      if: steps.cygwin-setup.outcome == 'failure'
      uses: cygwin/cygwin-install-action@v6
      with:
        packages: |
          cmake
          gcc-core
          gcc-g++
          make
          netcdf
          libnetcdf-devel
          hdf5
          libhdf5-devel
          diffutils
          coreutils
          grep
          file
          tar

    - name: Prepare Cygwin workspace
      shell: D:\cygwin\bin\bash.exe --login -o igncr -eo pipefail '{0}'
      run: |
        src="$(cygpath -u "$GITHUB_WORKSPACE")"
        work="/tmp/dbd2netcdf-work"
        rm -rf "$work"
        mkdir -p "$work"

        # Use tar to copy files - avoids permission preservation issues on Cygwin
        (cd "$src" && tar cf - --exclude='.git' .) | (cd "$work" && tar xf -)

        echo "CYGWIN_WORKSPACE=$work" >> $GITHUB_ENV

        # Verify copy succeeded
        test -f "$work/CMakeLists.txt" || { echo "ERROR: CMakeLists.txt not found"; exit 1; }

    - name: Display compiler version
      run: |
        gcc --version
        g++ --version
        cmake --version

    - name: Verify NetCDF tools
      run: |
        cd "$CYGWIN_WORKSPACE"
        nc-config --version
        if ncdump --version >/dev/null 2>&1; then
          ncdump --version
        else
          if command -v ncdump >/dev/null 2>&1; then
            echo "ncdump found: $(command -v ncdump)"
          else
            echo "ncdump not found"
            exit 1
          fi
        fi

    - name: Configure CMake
      run: |
        cd "$CYGWIN_WORKSPACE"
        # Clean any existing build directory
        rm -rf build
        # Use Cygwin's make explicitly (not Strawberry Perl's gmake)
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_MAKE_PROGRAM=/usr/bin/make \
          -G "Unix Makefiles"

    - name: Build
      run: |
        cd "$CYGWIN_WORKSPACE"
        cmake --build build --config Release

    - name: List built executables
      run: |
        ls -lh "$CYGWIN_WORKSPACE/bin/"
        file "$CYGWIN_WORKSPACE/bin/"*

    - name: Run tests
      timeout-minutes: 15
      run: |
        cd "$CYGWIN_WORKSPACE/build"
        ctest --output-on-failure --timeout 120 || {
          echo "=== Test failure diagnostics ==="
          cat Testing/Temporary/LastTest.log 2>/dev/null || true
          ls -la "$CYGWIN_WORKSPACE/test/"
          exit 1
        }

  build-alma:
    name: Alma Linux 8 (GCC 8.5)
    runs-on: ubuntu-latest
    container:
      image: almalinux:8

    steps:
    - name: Install git (required for checkout)
      run: |
        dnf install -y git

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        dnf install -y epel-release
        dnf config-manager --set-enabled powertools || \
          dnf config-manager --set-enabled crb
        dnf install -y cmake gcc-c++ make netcdf netcdf-devel hdf5-devel file diffutils

    - name: Display compiler version
      run: |
        gcc --version
        g++ --version
        cmake --version

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: List built executables
      run: |
        ls -lh bin/
        file bin/*

    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure

    - name: Verify GCC 8.5 stdc++fs linking
      run: |
        # Verify that stdc++fs is being linked for GCC 8.x
        ldd bin/dbd2netCDF | grep stdc++ || echo "stdc++ found in dependencies"

  build-rocky:
    name: Rocky Linux 9
    runs-on: ubuntu-latest
    container:
      image: rockylinux:9

    steps:
    - name: Install git (required for checkout)
      run: |
        dnf install -y git

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        dnf install -y epel-release
        dnf config-manager --set-enabled crb
        dnf install -y cmake gcc-c++ make netcdf netcdf-devel hdf5-devel file diffutils

    - name: Display compiler version
      run: |
        gcc --version
        g++ --version
        cmake --version

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: List built executables
      run: |
        ls -lh bin/
        file bin/*

    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure

  build-windows:
    name: Windows (MSVC)
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.11'
        channels: conda-forge
        channel-priority: strict
        activate-environment: dbd2netcdf

    - name: Install dependencies via conda
      run: |
        conda install -y libnetcdf hdf5 cmake ninja

    - name: Configure CMake
      run: |
        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_C_COMPILER=cl -DCMAKE_CXX_COMPILER=cl `
          -DCMAKE_PREFIX_PATH="$env:CONDA_PREFIX\Library"

    - name: Build
      run: cmake --build build --config Release

    - name: List built executables
      run: Get-ChildItem -Path bin

    - name: Run tests
      run: |
        Set-Location build
        ctest -C Release --output-on-failure
